---
layout: post
title: "Error Notifications when Running Scheduled Jobs"
tags: [rstats, rscript]
---

There are several ways to send notifications with R when a scheduled job/process has completed running, but if it errors during that process then we still 
want to have a notification that the script has been unsuccessful. Normally a scheduled job is set-up by using `Rscript`. Normally if a script is being
scheduled, then it generally should be in a good position to run every time without erroring. However there may be times where this is not the case, for
example the data from the previous day hasn't updated, the response of an API call has changed, or simply a new edge case has appeared that hasn't previously
been tested. When this happens the script will exit and the only way to find this out is to actively search the log files to find where the error happened.

Here we will look at a way where if an Rscript errors, then you will get be notified within seconds.

## Set-Up

Creating an automated job is simple enough to do in R; there are different packages available depending on the OS the job is being scheduled on:

- [`taskscheduleR`](https://github.com/bnosac/taskscheduleR) for Windows
- [`cronR`](https://github.com/bnosac/cronR) for Linux/Unix systems

To run a script every day at 6am, in time for the status of the run to be sent for the start of the dat, we can run to set up a job.

```r
# taskscheduleR
taskscheduleR::taskscheduler_create(
  taskname = "my_daily_process", 
  rscript = "path/to/script", 
  schedule = "DAILY", 
  starttime = "06:00"
)

#cronR
cronR::cron_add(
  command = cronR::cron_rscript("path/to/script"),
  frequency = "daily",
  at = "06:00"
)
```

## Error Handling

### Logging

```r
log_file <- tempfile()
sink(log_file)
sink(log_file, type = "message")
```

### `.Last`

`.Last` is an useful variable to be aware of. When you decide to close down an R session, if `.Last` has been assigned in the global environment,
then that function will be run before R fully shuts itself down. If you look at the documentaion of `quit` by default `runLast`, whether or not
`.Last` is run, is set to to `TRUE`. **However** when running `Rscript` and there is an error, this defaults to `FALSE`, meaning that we would
still never see that e-mail.

To get around this, we can change how errors are handled when run within the scheduled job by changing the error option to run the `.Last` function.

```r
if (!interactive) {
  options(error = (\() quit("no", 1, runLast = TRUE))())
}
```

The reason for checking whether or not the session is interactive, is when reproducing the error in a normal session, we don't want to close the
session when we run the errorous code.

### E-mail



## Final Script

```r
if (!interactive()) {
  .Last <- function() {
    blastula::send_mail(
      from = "username@gmail.com",
      to = "username@gmail.com",
      subject = "Scheduled Job Result"
    )
  }
  
  options(error = (\() quit("no", 1, runLast = TRUE))())
  
  log_file <- tempfile()
  sink(log_file)
  sink(log_file, type = "message")
}



```

## Alternatives

- Push notifications rather than e-mail
